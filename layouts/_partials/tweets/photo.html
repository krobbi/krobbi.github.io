{{ $thumbSize := 640 }}
{{ $id := .photo.id }}
{{ if not $id }}
	{{ errorf "Tweet #%s has a photo with a missing ID." .tweetID }}
{{ end }}
{{ $alt := .photo.alt }}
{{ if not $alt }}
	{{ errorf "The Tweet photo %q requires alt text. See Tweet #%s" $id .tweetID }}
{{ end }}
{{ $photo := resources.Get (printf "img/tweets/%s.png" $id) }}
{{ $thumb := $photo.Fit (printf "%[1]dx%[1]d png" $thumbSize) | resources.Copy (
	printf "img/tweets/%s-thumb.png" $id
) }}
{{ $jpegThumb := $photo.Fit (printf "%[1]dx%[1]d jpeg" $thumbSize) | resources.Copy (
	printf "img/tweets/%s-thumb.jpg" $id
) }}
{{ if lt ($jpegThumb.Content | len) ($thumb.Content | len) }}
	{{ $thumb = $jpegThumb }}
{{ end }}
{{ with index site.Data.tweet_photo_jpeg_quality $id }}
	{{ $jpegPhoto := $photo.Process (printf "jpeg q%d" .) | resources.Copy (printf "img/tweets/%s.jpg" $id) }}
	{{ if gt ($jpegPhoto.Content | len) ($photo.Content | len) }}
		{{ errorf "JPEG Tweet photo %q is larger than its source. Reduce its quality" $id }}
	{{ end }}
	{{ $photo = $jpegPhoto }}
{{ end }}
{{ if and
	(le ($photo.Content | len) ($thumb.Content | len))
	(or (ge $photo.Width $photo.Height) (le $photo.Height $thumbSize))
}}
	{{ $thumb = $photo }}
{{ end }}
<a
	href="{{ $photo.RelPermalink }}"
	target="_blank"
	rel="noopener noreferrer"
	class="tweet-photo-link"
>
	<img
		src="{{ $thumb.RelPermalink }}"
		{{ if .isPreview }}
			loading="lazy"
		{{ end }}
		alt="{{ $alt }}"
		class="tweet-photo"
	>
</a>
